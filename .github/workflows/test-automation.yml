name: TestVagrant Automation Tests

on:
  push:
    branches: [ main, master, develop ]
  pull_request:
    branches: [ main, master, develop ]
  workflow_dispatch: # Allows manual trigger from Actions tab

jobs:
  test:
    runs-on: ubuntu-latest
    
    strategy:
      matrix:
        java: [ '11', '17' ]
    
    name: Run Tests with Java ${{ matrix.java }}
    
    steps:
      # Step 1: Checkout repository
      - name: Checkout code
        uses: actions/checkout@v4
      
      # Step 2: Set up JDK
      - name: Set up JDK ${{ matrix.java }}
        uses: actions/setup-java@v4
        with:
          java-version: ${{ matrix.java }}
          distribution: 'temurin'
          cache: 'maven'
      
      # Step 3: Install Chrome browser
      - name: Install Chrome Browser
        run: |
          wget -q -O - https://dl-ssl.google.com/linux/linux_signing_key.pub | sudo apt-key add -
          sudo sh -c 'echo "deb [arch=amd64] http://dl.google.com/linux/chrome/deb/ stable main" >> /etc/apt/sources.list.d/google-chrome.list'
          sudo apt-get update
          sudo apt-get install -y google-chrome-stable
          google-chrome --version
      
      # Step 4: Verify Maven version
      - name: Verify Maven version
        run: mvn --version
      
      # Step 5: Clean and compile the project
      - name: Clean and Compile
        run: mvn clean compile
      
      # Step 6: Run tests
      - name: Run TestNG Tests
        run: mvn test
        continue-on-error: true
      
      # Step 7: Generate Allure Report
      - name: Generate Allure Report
        if: always()
        run: mvn allure:report
      
      # Step 8: Upload Allure Results
      - name: Upload Allure Results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: allure-results-java-${{ matrix.java }}
          path: target/allure-results/
          retention-days: 30
      
      # Step 9: Upload Allure Report
      - name: Upload Allure Report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: allure-report-java-${{ matrix.java }}
          path: target/allure-report/
          retention-days: 30
      
      # Step 10: Upload test reports
      - name: Upload Test Reports
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: test-reports-java-${{ matrix.java }}
          path: |
            target/surefire-reports/
            test-output/
            Screenshots/
          retention-days: 30
      
      # Step 11: Upload screenshots
      - name: Upload Screenshots
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: screenshots-java-${{ matrix.java }}
          path: Screenshots/
          retention-days: 30
      
      # Step 12: Publish Test Results
      - name: Publish Test Results
        if: always()
        uses: EnricoMi/publish-unit-test-result-action@v2
        with:
          files: |
            target/surefire-reports/*.xml
            test-output/junitreports/*.xml
          check_name: Test Results (Java ${{ matrix.java }})
          comment_title: Test Results Summary (Java ${{ matrix.java }})

  # Job to report overall status
  report:
    needs: test
    runs-on: ubuntu-latest
    if: always()
    
    steps:
      - name: Check test results
        run: |
          echo "Tests completed. Check the test reports artifacts for details."

